<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <link th:href="@{/css/app.css}" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>IG Sonar Dashboard</title>
    <script>
        let currentReports = [];

        // Load reports from /dashboard/reports/data
        async function loadReports() {
            const response = await fetch('/dashboard/reports/data');
            const data = await response.json();
            currentReports = data; // store for download

            const tableBody = document.getElementById('report-body');
            tableBody.innerHTML = ''; // clear table
			var srno = 0;
            data.forEach(report => {
                let qualityGateStyle = report.qualityGate === 'PASSED'
                    ? 'background-color: #4CAF50; color: white;'
                    : 'background-color: #EF4B4B; color: white;';
                let ragStatusStyle = report.ragStatus === 'Green'
                    ? 'font-weight: bold; color: #4CAF50;'
                    : (report.ragStatus === 'Amber'
                    ? 'font-weight: bold;color: #FFBF00;' : 'font-weight: bold;color: #EF4B4B;');
				srno=srno+1;

                 let row = `<tr>
				<td>${srno}</td>
                    <td>${report.gameName}</td>
                    <td>${report.key}</td>
                    <td>${report.date}</td>
                     <td style="${qualityGateStyle}">${report.qualityGate}</td>
                    <td>${report.codeCoverage}</td>
                    <td>${report.bugs}</td>
                    <td>${report.codeSmell}</td>
                    <td>${report.security}</td>
                    <td>${report.vulnerabilities}</td>
                    <td style="font-weight: bold;">${report.grade}</td>
                    <td style="${ragStatusStyle}">${report.ragStatus}</td>
                    <td><a href="${report.sonarReportUrl}" target="_blank">Link</a></td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }

        // Download CSV by calling /sonar/export and prompting file download
        async function downloadCSV() {
            try {
                const response = await fetch('/sonar/export');

                if (!response.ok) {
                    alert('Failed to download file.');
                    return;
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                // Try to get filename from headers
                const disposition = response.headers.get('Content-Disposition');
                let filename = 'game_reports.csv';
                if (disposition && disposition.includes('filename=')) {
                    const match = disposition.match(/filename="?([^"]+)"?/);
                    if (match && match[1]) filename = match[1];
                }
                a.download = filename;

                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                alert('Download successful!');
            } catch (error) {
                alert('Error while downloading file.');
                console.error(error);
            }
        }

        // Refresh data by calling /dashboard/refresh and then reload table
        async function refreshReports() {
            try {
                const response = await fetch('/dashboard/refresh', { method: 'POST' });
                if (response.ok) {
                    alert('Data refreshed successfully!');
                    await loadReports(); // reload table
                } else {
                    alert('Failed to refresh data.');
                }
            } catch (error) {
                alert('Error while refreshing data.');
                console.error(error);
            }
        }

        window.onload = loadReports;

let sortDirection = {};

function sortTable(colIndex) {
  const table = document.getElementById("myTable");
  const rows = Array.from(table.rows).slice(1); // exclude header
  const ths = table.querySelectorAll("th");

  // Reset all column headers
  ths.forEach(th => th.classList.remove("sort-asc", "sort-desc"));

  let ascending = !sortDirection[colIndex]; // toggle direction
  sortDirection[colIndex] = ascending;

  ths[colIndex].classList.add(ascending ? "sort-asc" : "sort-desc");

  rows.sort((rowA, rowB) => {
    let valA = rowA.cells[colIndex].innerText;
    let valB = rowB.cells[colIndex].innerText;

    // Check if numeric
    const isNumeric = !isNaN(parseFloat(valA)) && !isNaN(parseFloat(valB));
    if (isNumeric) {
      valA = parseFloat(valA);
      valB = parseFloat(valB);
    } else {
      valA = valA.toLowerCase();
      valB = valB.toLowerCase();
    }

    if (valA < valB) return ascending ? -1 : 1;
    if (valA > valB) return ascending ? 1 : -1;
    return 0;
  });

  // Append sorted rows
  const tbody = table.tBodies[0];
  tbody.innerHTML = "";
  rows.forEach(row => tbody.appendChild(row));
}
    </script>
</head>
<body>

    <div class="header">
        <img src="/images/ig-logo.png" alt="Company Logo" class="logo"/>
        <div class="label">Sonar Dashboard</div>
        <button class="btn refresh-btn" onclick="refreshReports()"><i class="fas fa-sync-alt"></i> Refresh</button>
        <button class="btn download-btn" onclick="downloadCSV()"><i class="fas fa-download"></i> Download</button></div>

    <table class="styled-table" id="myTable">
        <tr>
            <th onclick="sortTable(0)">Seq No.</th>
            <th onclick="sortTable(1)">Project Name</th>
            <th onclick="sortTable(2)">Project Key</th>
            <th onclick="sortTable(3)">Run Date</th>
            <th onclick="sortTable(4)">Quality Gate</th>
            <th onclick="sortTable(5)">Coverage%</th>
            <th onclick="sortTable(6)">Bugs</th>
            <th onclick="sortTable(7)">Code Smell</th>
            <th onclick="sortTable(8)">Security</th>
            <th onclick="sortTable(9)">Vulnerabilities</th>
            <th onclick="sortTable(10)">Grade</th>
            <th onclick="sortTable(11)">RAG Status</th>
            <th>Sonar URL</th>
        </tr>
        <tbody id="report-body"></tbody>
    </table>
</body>
</html>




<!--    </script>-->
<!--</head>-->
<!--<body>-->
<!--<h1>Game Reports</h1>-->

<!--&lt;!&ndash; Buttons &ndash;&gt;-->
<!--<button onclick="downloadCSV()">Download CSV</button>-->
<!--<button onclick="refreshReports()">Refresh</button>-->

<!--&lt;!&ndash; Report Table &ndash;&gt;-->
<!--<table border="1" style="margin-top:10px;">-->
<!--    <thead>-->
<!--    <tr>-->
<!--        <th>Game Name</th>-->
<!--        <th>Sonar Report URL</th>-->
<!--        <th>Date</th>-->
<!--        <th>Quality Gate</th>-->
<!--        <th>Grade</th>-->
<!--        <th>RAG Status</th>-->
<!--        <th>Code Coverage %</th>-->
<!--        <th>Bugs</th>-->
<!--        <th>Code Smell</th>-->
<!--        <th>Security</th>-->
<!--        <th>Vulnerabilities</th>-->
<!--        <th>Tech Debt Ratio</th>-->
<!--        <th>Game Key</th>-->
<!--    </tr>-->
<!--    </thead>-->
<!--    <tbody id="report-body"></tbody>-->
<!--</table>-->
<!--</body>-->
<!--</html>-->

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <link th:href="@{/css/app.css}" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>IG Sonar Dashboard</title>
    <script>
        let currentReports = [];

        // Load reports from /dashboard/reports/data
        async function loadReports() {
            const response = await fetch('/dashboard/reports/data');
            const data = await response.json();
            currentReports = data; // store for download

            const tableBody = document.getElementById('report-body');
            tableBody.innerHTML = ''; // clear table

            var srno = 0;
            data.forEach(report => {
                let qualityGateStyle = report.qualityGate === 'PASSED'
                    ? 'background-color: #4CAF50; color: white;'
                    : 'background-color: #EF4B4B; color: white;';
                let ragStatusStyle = report.ragStatus === 'Green'
                    ? 'font-weight: bold; color: #4CAF50;'
                    : (report.ragStatus === 'Amber'
                    ? 'font-weight: bold;color: #FFBF00;' : 'font-weight: bold;color: #EF4B4B;');
				srno=srno+1;

                  srno=srno+1;
                let row = `<tr>
                    <td>${srno}</td>
                    <td>${report.gameName}</td>
                    <td>${report.key}</td>
                    <td>${report.date}</td>
                     <td style="${qualityGateStyle}">${report.qualityGate}</td>
                    <td>${report.codeCoverage}</td>
                    <td>${report.bugs}</td>
                    <td>${report.codeSmell}</td>
                    <td>${report.security}</td>
                    <td>${report.vulnerabilities}</td>
                    <td style="font-weight: bold;">${report.grade}</td>
                    <td style="${ragStatusStyle}">${report.ragStatus}</td>
                    <td><a href="${report.sonarReportUrl}" target="_blank">Link</a></td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }

        // Download CSV by calling /sonar/export and prompting file download
        async function downloadCSV() {
            try {
                const response = await fetch('/sonar/export');

                if (!response.ok) {
                    alert('Failed to download file.');
                    return;
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                // Try to get filename from headers
                const disposition = response.headers.get('Content-Disposition');
                let filename = 'game_reports.csv';
                if (disposition && disposition.includes('filename=')) {
                    const match = disposition.match(/filename="?([^"]+)"?/);
                    if (match && match[1]) filename = match[1];
                }
                a.download = filename;

                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                alert('Download successful!');
            } catch (error) {
                alert('Error while downloading file.');
                console.error(error);
            }
        }

        // Refresh data by calling /dashboard/refresh and then reload table
        async function refreshReports() {
            try {
                const response = await fetch('/dashboard/refresh', { method: 'POST' });
                if (response.ok) {
                    alert('Data refreshed successfully!');
                    await loadReports(); // reload table
                } else {
                    alert('Failed to refresh data.');
                }
            } catch (error) {
                alert('Error while refreshing data.');
                console.error(error);
            }
        }

        window.onload = loadReports;

    </script>
</head>
<body>

    <div class="header">
        <img src="/images/ig-logo.png" alt="Company Logo" class="logo"/>
        <div class="label">Sonar Dashboard</div>
        <button class="btn refresh-btn" onclick="refreshReports()"><i class="fas fa-sync-alt"></i> Refresh</button>
        <button class="btn download-btn" onclick="downloadCSV()"><i class="fas fa-download"></i> Download</button></div>

    <table class="styled-table">
        <tr>
            <th>Seq No.</th>
            <th>Project Name</th>
            <th>Project Key</th>
            <th>Run Date</th>
            <th>Quality Gate</th>
            <th>Coverage%</th>
            <th>Bugs</th>
            <th>Code Smell</th>
            <th>Security</th>
            <th>Vulnerabilities</th>
            <th>Grade</th>
            <th>RAG Status</th>
            <th>Sonar URL</th>
        </tr>
        <tbody id="report-body"></tbody>
    </table>
</body>
</html>